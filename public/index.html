<!DOCTYPE html>
<html>
<head>
    <title>Jupiter DCA Monitor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, rgba(0, 12, 45, 0.9) 0%, rgba(0, 18, 60, 0.9) 100%),
                        url('/images/space-bg.jpg');
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
            min-height: 100vh;
            color: #e0e0e0;
        }
        
        .ticker-container {
            background: rgba(13, 27, 42, 0.7);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(78, 216, 255, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
            width: 100%;
        }

        .token-summary {
            display: inline-flex;
            gap: 30px;
            animation: scroll 120s linear infinite;
            padding-right: 0;
        }

        .token-summary:hover {
            animation-play-state: paused;
        }

        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .token-block {
            display: inline-block;
            padding: 0 15px;
            border-right: 1px solid #363940;
            line-height: 1.4;
            font-size: 0.9em;
            min-width: 200px;
            white-space: nowrap;
        }

        .token-block:last-child {
            border-right: none;
        }

        .token-block strong {
            color: #0066cc;
            font-size: 1.1em;
            display: block;
            margin-bottom: 4px;
        }

        .messages-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .message-column {
            background: rgba(13, 27, 42, 0.7);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(78, 216, 255, 0.1);
        }

        .token-header {
            background: rgba(44, 45, 50, 0.7);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            white-space: pre-wrap;
        }

        .message {
            background: rgba(44, 45, 50, 0.7);
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            white-space: pre-wrap;
        }

        h2 {
            color: #4ed8ff;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(78, 216, 255, 0.15);
        }

        .message a {
            color: #4ed8ff;
            text-decoration: none;
        }

        .message a:hover {
            text-decoration: underline;
        }

        .filter-buttons {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .filter-button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: rgba(54, 57, 64, 0.8);
            color: #e0e0e0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .filter-button.active {
            background: linear-gradient(135deg, #006994 0%, #004c6b 100%);
            color: white;
            border: 1px solid rgba(78, 216, 255, 0.2);
        }

        .filter-button:hover {
            opacity: 0.9;
        }

        .chart-container {
            background: rgba(37, 38, 43, 0.7);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            height: 200px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chart-controls {
            margin-bottom: 10px;
        }

        .chart-button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: rgba(54, 57, 64, 0.8);
            color: #e0e0e0;
            margin-right: 5px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chart-button.active {
            background: linear-gradient(135deg, #006994 0%, #004c6b 100%);
            color: white;
            border: 1px solid rgba(78, 216, 255, 0.2);
        }

        .chart-button:hover {
            opacity: 0.9;
        }

        .messages-section {
            margin-top: 20px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Jupiter DCA Monitor</h1>
    
    <div class="ticker-container">
        <div id="summary" class="token-summary"></div>
    </div>

    <div class="messages-container">
        <div class="message-column">
            <h2>LOGOS DCA</h2>
            <div id="logos-summary" class="token-header"></div>
            <div class="chart-container">
                <div class="chart-controls">
                    <button class="chart-button active" onclick="setChartView('LOGOS', 'hour')">Hourly</button>
                    <button class="chart-button" onclick="setChartView('LOGOS', 'day')">Daily</button>
                </div>
                <canvas id="logos-chart"></canvas>
            </div>
            <div class="filter-buttons">
                <button class="filter-button active" onclick="setFilter('LOGOS', 'ALL')">ALL</button>
                <button class="filter-button" onclick="setFilter('LOGOS', 'BUY')">BUY</button>
                <button class="filter-button" onclick="setFilter('LOGOS', 'SELL')">SELL</button>
            </div>
            <div class="messages-section">
                <div id="logos-messages"></div>
            </div>
        </div>
        <div class="message-column">
            <h2>CHAOS DCA</h2>
            <div id="chaos-summary" class="token-header"></div>
            <div class="chart-container">
                <div class="chart-controls">
                    <button class="chart-button active" onclick="setChartView('CHAOS', 'hour')">Hourly</button>
                    <button class="chart-button" onclick="setChartView('CHAOS', 'day')">Daily</button>
                </div>
                <canvas id="chaos-chart"></canvas>
            </div>
            <div class="filter-buttons">
                <button class="filter-button active" onclick="setFilter('CHAOS', 'ALL')">ALL</button>
                <button class="filter-button" onclick="setFilter('CHAOS', 'BUY')">BUY</button>
                <button class="filter-button" onclick="setFilter('CHAOS', 'SELL')">SELL</button>
            </div>
            <div class="messages-section">
                <div id="chaos-messages"></div>
            </div>
        </div>
    </div>

    <script>
        let currentFilters = {
            'LOGOS': 'ALL',
            'CHAOS': 'ALL'
        };

        function setFilter(token, filter) {
            currentFilters[token] = filter;
            
            // Update button states
            const buttons = document.querySelectorAll(`.message-column:has(h2:contains('${token}')) .filter-button`);
            buttons.forEach(button => {
                button.classList.toggle('active', button.textContent === filter);
            });
            
            // Refresh the messages
            updateData();
        }

        function formatSummary(summaryText) {
            const lines = summaryText.split('\n');
            const tokenBlocks = new Map();
            let currentToken = '';
            let currentBlock = '';
            
            // Parse the summary text
            lines.forEach(line => {
                if (line.endsWith(':')) {
                    if (currentToken && currentBlock) {
                        tokenBlocks.set(currentToken, currentBlock);
                    }
                    currentToken = line.slice(0, -1);
                    currentBlock = '';
                } else if (line.trim() === '') {
                    if (currentToken && currentBlock) {
                        tokenBlocks.set(currentToken, currentBlock);
                    }
                    currentToken = '';
                    currentBlock = '';
                } else if (currentBlock !== undefined) {
                    currentBlock += line + '\n';
                }
            });

            // Store LOGOS and CHAOS summaries separately
            if (tokenBlocks.has('LOGOS')) {
                document.getElementById('logos-summary').innerText = 'LOGOS:\n' + tokenBlocks.get('LOGOS');
                tokenBlocks.delete('LOGOS');
            }
            if (tokenBlocks.has('CHAOS')) {
                document.getElementById('chaos-summary').innerText = 'CHAOS:\n' + tokenBlocks.get('CHAOS');
                tokenBlocks.delete('CHAOS');
            }

            // Format remaining tokens for ticker
            let html = '';
            tokenBlocks.forEach((block, token) => {
                const lines = block.split('\n').filter(line => line.trim());
                html += `
                    <div class="token-block">
                        <strong>${token}</strong><br>
                        ${lines.join('<br>')}
                    </div>`;
            });

            // Triple the content for smoother infinite scroll
            return html + html + html;
        }

        function formatMessage(message) {
            // Convert solscan links to clickable links
            return message.replace(
                /(Position:\s*)(https:\/\/solscan\.io\/account\/[a-zA-Z0-9]+)/g,
                '$1<a href="$2" target="_blank">$2</a>'
            );
        }

        function filterMessages(messages, token) {
            return messages
                .filter(msg => {
                    const isTokenMessage = msg.includes(`${token} DCA Position`);
                    if (!isTokenMessage) return false;

                    const filter = currentFilters[token];
                    if (filter === 'ALL') return true;
                    if (filter === 'BUY') return msg.includes('(Buying');
                    if (filter === 'SELL') return msg.includes('(Selling');
                    return true;
                })
                .map(msg => `<div class="message">${formatMessage(msg)}</div>`)
                .join('');
        }

        let updateInterval = 15000; // 15 seconds
        let consecutiveErrors = 0;
        let maxInterval = 60000; // Max 1 minute between updates

        async function updateData() {
            try {
                // Get messages
                const messagesResponse = await fetch('/api/telegram-messages');
                const messages = await messagesResponse.json();
                
                // Split messages by token
                document.getElementById('logos-messages').innerHTML = filterMessages(messages, 'LOGOS');
                document.getElementById('chaos-messages').innerHTML = filterMessages(messages, 'CHAOS');

                // Get and format summary
                const summaryResponse = await fetch('/api/summary');
                const summary = await summaryResponse.json();
                
                // Update ticker and summaries
                document.getElementById('summary').innerHTML = formatSummary(summary);
                
                // Add this line to update charts
                await updateCharts();

                // Clear and update token summaries
                document.getElementById('logos-summary').innerHTML = '';
                document.getElementById('chaos-summary').innerHTML = '';
                if (summary.includes('LOGOS:')) {
                    document.getElementById('logos-summary').innerText = 'LOGOS:\n' + 
                        summary.split('LOGOS:')[1].split('\n\n')[0];
                }
                if (summary.includes('CHAOS:')) {
                    document.getElementById('chaos-summary').innerText = 'CHAOS:\n' + 
                        summary.split('CHAOS:')[1].split('\n\n')[0];
                }

                // Reset error count on successful update
                consecutiveErrors = 0;
                updateInterval = 15000; // Reset to default interval

            } catch (error) {
                console.error('Error fetching data:', error);
                consecutiveErrors++;
                
                // Exponential backoff
                updateInterval = Math.min(updateInterval * 1.5, maxInterval);
                console.log(`Increasing update interval to ${updateInterval}ms`);
            }

            // Schedule next update
            setTimeout(updateData, updateInterval);
        }

        function createChart(canvasId, data) {
            const canvas = document.getElementById(canvasId);
            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
                existingChart.destroy();
            }

            return new Chart(canvas, {
                type: 'bar',  // Default type for bars
                data: {
                    labels: data.map(d => new Date(d.timestamp).toLocaleTimeString()),
                    datasets: [
                        {
                            label: 'Buy Orders',
                            data: data.map(d => d.buyOrders),
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderColor: 'rgb(75, 192, 192)',
                            borderWidth: 1,
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            label: 'Sell Orders',
                            data: data.map(d => d.sellOrders),
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgb(255, 99, 132)',
                            borderWidth: 1,
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            type: 'line',  // Override type for volume
                            label: 'Buy Volume',
                            data: data.map(d => d.buyVolume),
                            borderColor: 'rgb(46, 204, 113)',
                            borderWidth: 2,
                            fill: false,
                            yAxisID: 'y1',
                            order: 1
                        },
                        {
                            type: 'line',  // Override type for volume
                            label: 'Sell Volume',
                            data: data.map(d => d.sellVolume),
                            borderColor: 'rgb(231, 76, 60)',
                            borderWidth: 2,
                            fill: false,
                            yAxisID: 'y1',
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Orders'
                            },
                            beginAtZero: true,
                            grid: {
                                color: '#363940'
                            },
                            ticks: {
                                color: '#e0e0e0'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Volume'
                            },
                            beginAtZero: true,
                            grid: {
                                color: '#363940'
                            },
                            ticks: {
                                color: '#e0e0e0'
                            }
                        },
                        x: {
                            grid: {
                                color: '#363940'
                            },
                            ticks: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toLocaleString();
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    }
                }
            });
        }

        async function updateCharts() {
            try {
                const response = await fetch('/api/historical');
                const data = await response.json();
                
                createChart('logos-chart', data.LOGOS);
                createChart('chaos-chart', data.CHAOS);
            } catch (error) {
                console.error('Error updating charts:', error);
            }
        }

        // Initial update
        updateData();
    </script>
</body>
</html>
